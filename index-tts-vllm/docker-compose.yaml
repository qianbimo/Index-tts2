version: '3.9'

services:
  indextts2:
    build: .
    image: indextts2-vllm
    container_name: indextts2-vllm
    runtime: nvidia
    environment:
      MODEL_DIR: /app/checkpoints
      MODEL: IndexTeam/IndexTTS-2-vLLM     # 默认加载 IndexTTS-2 模型
      VLLM_USE_MODELSCOPE: 0               # 1=使用 ModelScope；0=使用 HuggingFace
      DOWNLOAD_MODEL: 1                    # 自动下载
      CONVERT_MODEL: 1                     # 自动转换权重
      GPU_MEMORY_UTILIZATION: 0.25         # GPU 显存占用比例
      PORT: 7861                           # API 端口
    ports:
      - "7861:7861"
    volumes:
      - ./checkpoints:/app/checkpoints     # 模型目录挂载
      - ./assets:/app/assets               # 资源文件
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            device_ids: ['2']
            capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7861/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      tts_net:
        ipv4_address: 172.50.0.10

networks:
  tts_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.50.0.0/16
